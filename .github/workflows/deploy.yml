name: Deploy

on:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: staging
        type: choice
        options:
          - staging
          - production

concurrency:
  group: deploy-${{ (github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')) && 'production' || 'staging' }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  # ────────────────────────────────────────────────────────────
  # CI gate — runs on every trigger before any deploy
  # ────────────────────────────────────────────────────────────
  ci:
    name: CI Gate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> "$GITHUB_OUTPUT"
      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml', '**/package.json') }}
          restore-keys: pnpm-store-${{ runner.os }}-
      - name: Install
        run: pnpm install --frozen-lockfile || pnpm install
      - name: Lint
        run: pnpm lint
      - name: Test
        run: pnpm test
      - name: Validate OpenAPI
        run: pnpm openapi:validate
      - name: Audit gate
        run: pnpm audit-gate
      - name: Build API
        run: pnpm --filter @caricash/api build
      - name: Build Web
        run: pnpm --filter @caricash/web build

  # ────────────────────────────────────────────────────────────
  # STAGING deploy — on push to main or manual dispatch
  # ────────────────────────────────────────────────────────────
  deploy-staging:
    name: Deploy to Staging
    needs: ci
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: staging
      url: https://api-staging.caricash.com/health

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Install
        run: pnpm install --frozen-lockfile || pnpm install

      - name: Configure D1 database ID for staging
        run: sed -i "s/REPLACE_WITH_STAGING_D1_DATABASE_ID/${{ secrets.CLOUDFLARE_D1_DATABASE_ID_STAGING }}/" packages/api/wrangler.toml

      - name: Provision Cloudflare resources
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: bash scripts/provision-cloudflare.sh staging

      - name: Apply D1 migrations (staging)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        working-directory: packages/api
        run: pnpm exec wrangler d1 migrations apply caricash-db-staging --env staging --remote

      - name: Deploy Posting DO Worker (staging)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        working-directory: packages/posting-do
        run: pnpm exec wrangler deploy --env staging

      - name: Deploy API Worker (staging)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        working-directory: packages/api
        run: pnpm exec wrangler deploy --env staging

      - name: Build frontend
        run: pnpm --filter @caricash/web build

      - name: Deploy frontend to Pages (staging)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: pnpm --filter @caricash/api exec wrangler pages deploy ../web/dist --project-name=caricash-web-staging --branch=staging --commit-dirty=true

      - name: Smoke tests (staging)
        env:
          DEPLOY_URL: https://api-staging.caricash.com
        run: bash scripts/smoke-test.sh

  # ────────────────────────────────────────────────────────────
  # PRODUCTION deploy — on release or manual dispatch
  # ────────────────────────────────────────────────────────────
  deploy-production:
    name: Deploy to Production
    needs: ci
    if: |
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: production
      url: https://api.caricash.com/health

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Install
        run: pnpm install --frozen-lockfile || pnpm install

      - name: Configure D1 database ID for production
        run: sed -i "s/REPLACE_WITH_PRODUCTION_D1_DATABASE_ID/${{ secrets.CLOUDFLARE_D1_DATABASE_ID_PROD }}/" packages/api/wrangler.toml

      - name: Provision Cloudflare resources
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: bash scripts/provision-cloudflare.sh production

      - name: Apply D1 migrations (production)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        working-directory: packages/api
        run: pnpm exec wrangler d1 migrations apply caricash-db --env production --remote

      - name: Deploy Posting DO Worker (production)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        working-directory: packages/posting-do
        run: pnpm exec wrangler deploy --env production

      - name: Deploy API Worker (production)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        working-directory: packages/api
        run: pnpm exec wrangler deploy --env production

      - name: Build frontend
        run: pnpm --filter @caricash/web build

      - name: Deploy frontend to Pages (production)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: pnpm --filter @caricash/api exec wrangler pages deploy ../web/dist --project-name=caricash-web --branch=main --commit-dirty=true

      - name: Smoke tests (production)
        env:
          DEPLOY_URL: https://api.caricash.com
        run: bash scripts/smoke-test.sh
